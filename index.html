<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Fluent Now - AI Language Learning</title>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <!-- CSS -->
  <script type="module">
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const y={Spanish:"español",French:"français",Italian:"italiano",German:"Deutsch",Portuguese:"português",Dutch:"Nederlands",Russian:"русский",Japanese:"日本語",Korean:"한국어","Chinese (Simplified)":"中文 (简体)",Arabic:"العربية",English:"English"},f={"flash-lite":"gemini-2.5-flash-lite-preview-06-17",flash:"gemini-2.5-flash",pro:"gemini-1.5-pro-latest"},v={daily_life:["morning routine","grocery shopping","commuting to work","weekend activities","cooking dinner","cleaning house","watching TV","reading a book"],travel:["booking a hotel","at the airport","ordering food abroad","asking for directions","visiting museums","taking photos","meeting locals","exploring markets"],food:["cooking a meal","restaurant dining","street food adventure","baking desserts","farmers market visit","wine tasting","cooking with friends","trying new recipes"],friendship:["making new friends","planning together","helping each other","celebrating birthdays","weekend hangouts","sharing secrets","group activities","supporting friends"],work:["job interview","team meeting","office lunch","project deadline","networking event","presentation day","remote working","career change"],shopping:["clothing store visit","electronics shopping","market bargaining","online ordering","gift buying","window shopping","sales hunting","returning items"],health:["doctor visit","gym workout","healthy cooking","wellness routine","mental health care","medical checkup","fitness goals","stress management"],hobbies:["learning instrument","painting class","sports practice","reading club","photography walk","gardening time","crafting project","game night"],family:["family dinner","holiday gathering","helping parents","children playing","family vacation","visiting relatives","family traditions","home projects"],nature:["hiking adventure","beach day","camping trip","garden work","wildlife watching","mountain climbing","river rafting","nature photography"],technology:["learning new app","video call","social media","online learning","tech support","digital payments","smart home","cybersecurity"],education:["language class","study group","exam preparation","university life","skill development","online courses","library research","tutoring session"]},p={sourceLanguage:"Spanish",targetLanguage:"English",model:"flash-lite"};class b{constructor(e,t="flash-lite"){this.apiKey=e,this.model=t,this.baseUrl="https://generativelanguage.googleapis.com/v1beta/models"}setModel(e){this.model=e}getEndpoint(){const e=f[this.model];return`${this.baseUrl}/${e}:generateContent`}async makeRequest(e,t=null){var n,s,a,i,c;try{const r=[];t&&(r.push({role:"user",parts:[{text:t}]}),r.push({role:"model",parts:[{text:"I understand. I'll follow these instructions carefully."}]})),r.push({role:"user",parts:[{text:e}]});const o=await fetch(`${this.getEndpoint()}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:r,generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:2048}})});if(!o.ok){const l=await o.text();throw new Error(`API Error ${o.status}: ${l}`)}const m=await o.json();if(!((c=(i=(a=(s=(n=m.candidates)==null?void 0:n[0])==null?void 0:s.content)==null?void 0:a.parts)==null?void 0:i[0])!=null&&c.text))throw new Error("No content generated by API");return m.candidates[0].content.parts[0].text.trim()}catch(r){throw console.error("Gemini API Error:",r),new Error(`AI service error: ${r.message}`)}}async makeStructuredRequest(e,t,n=null){var s,a,i,c,r;try{const o=[];n&&(o.push({role:"user",parts:[{text:n}]}),o.push({role:"model",parts:[{text:"I understand. I'll follow these instructions carefully."}]})),o.push({role:"user",parts:[{text:e}]});const m={contents:o,generationConfig:{temperature:.7,topK:40,topP:.95,maxOutputTokens:2048,responseMimeType:"application/json",responseSchema:t}},l=await fetch(`${this.getEndpoint()}?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(!l.ok){const g=await l.text();throw new Error(`API Error ${l.status}: ${g}`)}const d=await l.json();if(!((r=(c=(i=(a=(s=d.candidates)==null?void 0:s[0])==null?void 0:a.content)==null?void 0:i.parts)==null?void 0:c[0])!=null&&r.text))throw new Error("No content generated by API");return d.candidates[0].content.parts[0].text.trim()}catch(o){throw console.error("Gemini API Error:",o),new Error(`AI service error: ${o.message}`)}}async validateApiKey(){try{return await this.makeRequest('Hello, please respond with "API key validated"'),{valid:!0}}catch(e){return{valid:!1,error:e.message.includes("403")?"Invalid API key":"Connection failed"}}}async generateStory(e,t,n,s){const a="You are a language learning story generator. Generate stories that strictly adhere to CEFR language proficiency levels. Your stories must be educational, engaging, and precisely calibrated to the specified difficulty level.",i=`Write a short story in ${e} STRICTLY following ${t.toUpperCase()} CEFR level requirements:

STRICT CEFR ${t.toUpperCase()} REQUIREMENTS:
- VOCABULARY: ${this.getCEFRSpec(t,"vocabulary")}
- GRAMMAR: ${this.getCEFRSpec(t,"grammar")} 
- SENTENCES: ${this.getCEFRSpec(t,"sentences")}
- COMPLEXITY: ${this.getCEFRSpec(t,"complexity")}

Story theme: ${n} (specifically: ${s})

Requirements:
- Length: 100-150 words for ${t.toUpperCase()}
- Use ONLY vocabulary appropriate for ${t.toUpperCase()} level
- Use ONLY grammar structures appropriate for ${t.toUpperCase()} level
- Make it engaging and culturally appropriate
- Focus on everyday, relatable situations

Generate ONLY the story text, no additional commentary.`;return await this.makeRequest(i,a)}async generateStructuredStory(e,t,n,s){const a="You are a language learning story generator. Generate stories that strictly adhere to CEFR language proficiency levels. Your stories must be educational, engaging, and precisely calibrated to the specified difficulty level.",i=`Write a short story in ${e} STRICTLY following ${t.toUpperCase()} CEFR level requirements:

STRICT CEFR ${t.toUpperCase()} REQUIREMENTS:
- VOCABULARY: ${this.getCEFRSpec(t,"vocabulary")}
- GRAMMAR: ${this.getCEFRSpec(t,"grammar")} 
- SENTENCES: ${this.getCEFRSpec(t,"sentences")}
- COMPLEXITY: ${this.getCEFRSpec(t,"complexity")}

Story theme: ${n} (specifically: ${s})

Requirements:
- Length: 100-150 words for ${t.toUpperCase()}
- Use ONLY vocabulary appropriate for ${t.toUpperCase()} level
- Use ONLY grammar structures appropriate for ${t.toUpperCase()} level
- Make it engaging and culturally appropriate
- Focus on everyday, relatable situations

Break the story into individual sentences for translation practice.`,c={type:"object",properties:{sentences:{type:"array",items:{type:"string"},description:"Array of individual sentences that make up the story"}},required:["sentences"]};try{const r=await this.makeStructuredRequest(i,c,a);return JSON.parse(r).sentences||[]}catch(r){console.error("Structured generation failed, falling back to regular generation:",r);const o=await this.makeRequest(i,a),m=o.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(m)try{return JSON.parse(m[1]).sentences||[]}catch(l){console.error("Failed to parse extracted JSON:",l)}return o.split(/[.!?]+/).filter(l=>l.trim().length>0).map(l=>l.trim()+".")}}getCEFRSpec(e,t){var s;return((s={a1:{vocabulary:"High frequency words (most common 1000-1500 words), basic nouns, verbs, adjectives",grammar:"Present tense, simple past, basic sentence structures, no subordinate clauses",sentences:"Very short sentences (5-8 words average), simple subject-verb-object structure",complexity:"Single ideas per sentence, no complex connections between ideas, concrete situations only"},a2:{vocabulary:"Common words (2000-2500 words), routine activities, personal information, basic emotions",grammar:"Present, past, future tenses, basic modal verbs (can, must, should), simple conditionals",sentences:"Short sentences (8-12 words), some compound sentences with 'and', 'but', 'or'",complexity:"Simple connections between ideas, familiar topics, basic cause and effect"},b1:{vocabulary:"Extended vocabulary (3000-4000 words), abstract concepts, opinions, experiences",grammar:"All major tenses, conditional sentences, passive voice, relative clauses",sentences:"Medium length sentences (12-18 words), complex sentences with subordinate clauses",complexity:"Clear connections between ideas, arguments, hypothetical situations, past experiences"},b2:{vocabulary:"Wide vocabulary (4000-6000 words), specialized terms, nuanced expressions",grammar:"Advanced structures, subjunctive mood, complex conditionals, advanced passive constructions",sentences:"Longer sentences (15-25 words), sophisticated linking, varied sentence structures",complexity:"Abstract ideas, detailed arguments, implicit meanings, cultural references"},c1:{vocabulary:"Extensive vocabulary (6000+ words), idiomatic expressions, sophisticated terms",grammar:"All grammatical structures, subtle distinctions, stylistic variations",sentences:"Complex sentences (20+ words), sophisticated discourse markers, varied rhetorical devices",complexity:"Nuanced arguments, cultural subtleties, implicit meanings, sophisticated humor"}}[e.toLowerCase()])==null?void 0:s[t])||""}async translateText(e,t,n){const s=`Translate this ${t} text to ${n}. Provide only the translation, no explanations:

${e}`;return await this.makeRequest(s)}async rateTranslation(e,t,n,s,a){const i=`As a language teacher, evaluate this translation:

ORIGINAL (${s}): ${e}

STUDENT TRANSLATION (${a}): ${t}

REFERENCE TRANSLATION (${a}): ${n}

Provide detailed feedback in this format:
**Score: X/10**

**What you did well:**
- [positive points]

**Areas for improvement:**
- [specific issues with corrections]

**Key takeaways:**
- [important lessons]

Be encouraging but specific about errors.`;return await this.makeRequest(i)}async rateSentenceTranslations(e,t,n,s){const a=e.map((r,o)=>({original:r,translation:t[o]||"",index:o})).filter(r=>r.translation.trim().length>0);if(a.length===0)throw new Error("Please translate at least one sentence before submitting");const c=`As a language teacher, evaluate these sentence translations and provide both individual feedback and an overall assessment.

SENTENCES TO EVALUATE:
${a.map((r,o)=>`${o+1}. ORIGINAL (${n}): "${r.original}"
   STUDENT TRANSLATION (${s}): "${r.translation}"`).join(`

`)}

For each sentence, provide:
1. A reference translation
2. Brief feedback covering accuracy, grammar, and word choice
3. Specific suggestions for improvement

Then provide an overall summary of the student's performance with 2-3 key learning points.

Format your response as JSON with this structure:
{
  "sentenceEvaluations": [
    {
      "sentenceNumber": 1,
      "referenceTranslation": "correct translation here",
      "feedback": "brief feedback here"
    }
  ],
  "overallFeedback": "overall assessment and learning points here",
  "translatedCount": ${a.length},
  "totalSentences": ${e.length}
}`;try{const r=await this.makeRequest(c);let o;try{o=JSON.parse(r)}catch{const d=r.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);if(d)o=JSON.parse(d[1]);else throw new Error("Could not parse AI response as JSON")}return{sentenceFeedback:a.map((l,d)=>{var h;const g=((h=o.sentenceEvaluations)==null?void 0:h[d])||{};return{sentenceIndex:l.index,original:l.original,userTranslation:l.translation,referenceTranslation:g.referenceTranslation||"Reference not provided",feedback:g.feedback||"Feedback not provided"}}),overallFeedback:o.overallFeedback||"Overall feedback not provided",totalSentences:e.length,translatedCount:a.length}}catch(r){return console.error("Batch sentence evaluation failed, falling back to individual evaluation:",r),await this.rateSentenceTranslationsIndividual(e,t,n,s)}}async rateSentenceTranslationsIndividual(e,t,n,s){const a=e.map((d,g)=>({original:d,translation:t[g]||"",index:g})).filter(d=>d.translation.trim().length>0),i=a.map(d=>this.translateText(d.original,n,s)),c=await Promise.all(i),r=a.map((d,g)=>{const h=`As a language teacher, evaluate this sentence translation:

ORIGINAL (${n}): ${d.original}

STUDENT TRANSLATION (${s}): ${d.translation}

REFERENCE TRANSLATION (${s}): ${c[g]}

Provide concise feedback focusing on accuracy, grammar, and word choice.`;return this.makeRequest(h)}),o=await Promise.all(r),m=`Summarize the student's translation performance for ${a.length} out of ${e.length} sentences. Provide 2-3 key learning points for improvement.`,l=await this.makeRequest(m);return{sentenceFeedback:a.map((d,g)=>({sentenceIndex:d.index,original:d.original,userTranslation:d.translation,referenceTranslation:c[g],feedback:o[g]})),overallFeedback:l,totalSentences:e.length,translatedCount:a.length}}async generateMiniLesson(e,t,n,s){const a=`Create a focused mini-lesson based on this translation attempt:

ORIGINAL (${n}): ${e}
STUDENT ATTEMPT (${s}): ${t}

Create a mini-lesson covering:
1. **Grammar Focus**: Main grammatical concepts
2. **Vocabulary**: Key words and their usage
3. **Practice**: 2-3 simple exercises

Keep it concise and practical.`;return await this.makeRequest(a)}async generateSentenceMiniLesson(e,t,n){const s=e.map((r,o)=>`${o+1}. ORIGINAL (${t}): "${r.original}"
   STUDENT TRANSLATION (${n}): "${r.translation}"`).join(`

`),a={type:"object",properties:{title:{type:"string",description:"Title for the mini lesson (e.g., 'Verb Conjugation and Word Order')"},grammarFocus:{type:"string",description:"Main grammatical patterns and structures the student should learn"},vocabulary:{type:"array",items:{type:"object",properties:{word:{type:"string",description:"The vocabulary word"},meaning:{type:"string",description:"English translation/meaning"},example:{type:"string",description:"Example sentence using the word"}},required:["word","meaning","example"]},description:"Key vocabulary words from the translations"},commonMistakes:{type:"array",items:{type:"object",properties:{mistake:{type:"string",description:"The common mistake pattern"},correction:{type:"string",description:"How to fix it"},example:{type:"string",description:"Correct example sentence"}},required:["mistake","correction","example"]},description:"Common mistake patterns from student translations"},exercises:{type:"array",items:{type:"object",properties:{type:{type:"string",enum:["translation","fill-in-blank","conjugation"],description:"Type of exercise"},instruction:{type:"string",description:"Instructions for the exercise"},question:{type:"string",description:"The exercise question/prompt"},answer:{type:"string",description:"The correct answer"},explanation:{type:"string",description:"Why this is the correct answer"}},required:["type","instruction","question","answer","explanation"]},description:"Interactive exercises to practice the concepts",minItems:3,maxItems:5}},required:["title","grammarFocus","vocabulary","commonMistakes","exercises"]},i=`Create a structured mini-lesson based on these translation attempts:

${s}

Analyze the student's translation patterns and create a comprehensive lesson with:
1. A clear title that describes the main learning focus
2. Grammar focus explaining the key patterns
3. Vocabulary section with 3-5 important words from their translations
4. Common mistakes they made and how to correct them
5. 3-5 interactive exercises of these types:
   - translation: Translate sentences between ${t} and ${n}
   - fill-in-blank: Complete sentences with missing words/phrases
   - conjugation: Practice verb conjugations and forms

Make the exercises specific to their translation attempts and provide clear explanations for each answer.`,c="You are a language learning instructor creating structured mini-lessons. Always respond with valid JSON matching the provided schema. Focus on the student's actual translation attempts to create targeted, practical exercises.";try{const r=await this.makeStructuredRequest(i,a,c);return JSON.parse(r)}catch(r){console.error("Structured mini lesson generation failed:",r);const o=`Create a focused mini-lesson based on these translation attempts:

${s}

Analyze the student's translation patterns and create a lesson covering:
1. **Grammar Focus**: Main grammatical patterns and structures the student should learn
2. **Vocabulary**: Key words and their usage from the translations
3. **Common Mistakes**: Patterns you notice in the student's translations
4. **Practice**: 2-3 specific exercises to improve these areas

Focus on the most important learning points from their actual translation attempts. Keep it concise and practical.`;return await this.makeRequest(o)}}async chat(e,t=null){let n=e;return t&&(n=`Context: ${t}

User question: ${e}`),await this.makeRequest(n,"You are a helpful language learning assistant. Answer questions about grammar, vocabulary, translations, and language learning. Be concise but informative. Use examples when helpful.")}}class S{constructor(e){this.geminiAPI=e,this.currentStory=null,this.currentSentences=[],this.referenceTranslation=null}setCurrentStory(e){this.currentStory=e,this.referenceTranslation=null}setCurrentSentences(e){this.currentSentences=e,this.currentStory=e.join(" ")}async processTranslation(e,t,n){if(!this.currentStory)throw new Error("No story available for translation");if(!e||e.trim().length===0)throw new Error("Please enter your translation before submitting");try{return this.referenceTranslation||(this.referenceTranslation=await this.geminiAPI.translateText(this.currentStory,t,n)),{feedback:await this.geminiAPI.rateTranslation(this.currentStory,e.trim(),this.referenceTranslation,t,n),referenceTranslation:this.referenceTranslation,userTranslation:e.trim()}}catch(s){throw console.error("Translation processing error:",s),new Error(`Failed to process translation: ${s.message}`)}}async generateMiniLesson(e,t,n){if(!this.currentStory||!e)throw new Error("Story and translation required for mini lesson");try{return await this.geminiAPI.generateMiniLesson(this.currentStory,e.trim(),t,n)}catch(s){throw console.error("Mini lesson generation error:",s),new Error(`Failed to generate lesson: ${s.message}`)}}async generateSentenceMiniLesson(e,t,n){if(!e||e.length===0)throw new Error("No translations provided for mini lesson");try{return await this.geminiAPI.generateSentenceMiniLesson(e,t,n)}catch(s){throw console.error("Sentence mini lesson generation error:",s),new Error(`Failed to generate lesson: ${s.message}`)}}async processSentenceTranslations(e,t){if(!this.currentSentences||this.currentSentences.length===0)throw new Error("No sentences available for translation");const n=[];for(let s=0;s<this.currentSentences.length;s++){const a=document.getElementById(`sentence-translation-${s}`);n.push(a?a.value.trim():"")}try{return await this.geminiAPI.rateSentenceTranslations(this.currentSentences,n,e,t)}catch(s){throw console.error("Sentence translation processing error:",s),new Error(`Failed to process translations: ${s.message}`)}}displaySentenceFeedback(e,t){if(!e)return;const n=typeof marked<"u"&&marked.parse?marked.parse(t.overallFeedback):t.overallFeedback;let s="";t.sentenceFeedback.forEach((a,i)=>{const c=typeof marked<"u"&&marked.parse?marked.parse(a.feedback):a.feedback;s+=`
                <div class="sentence-feedback-item">
                    <h5>Sentence ${a.sentenceIndex+1}</h5>
                    <div class="sentence-feedback-original">
                        <strong>Original:</strong> <em>"${a.original}"</em>
                    </div>
                    <div class="sentence-feedback-user">
                        <strong>Your translation:</strong> "${a.userTranslation}"
                    </div>
                    <div class="sentence-feedback-reference">
                        <strong>Reference:</strong> <em>"${a.referenceTranslation}"</em>
                    </div>
                    <div class="sentence-feedback-content">
                        ${c}
                    </div>
                </div>
            `}),e.innerHTML=`
            <div class="feedback-content">
                <div class="overall-feedback">
                    <h4>📊 Overall Performance</h4>
                    <p><strong>Translated:</strong> ${t.translatedCount} out of ${t.totalSentences} sentences</p>
                    ${n}
                </div>
                <div class="sentence-feedback">
                    <h4>💬 Individual Sentence Feedback</h4>
                    ${s}
                </div>
            </div>
        `,this.showResultsTabs("feedback")}displayFeedback(e,t){if(!e)return;const n=typeof marked<"u"&&marked.parse?marked.parse(t.feedback):t.feedback;e.innerHTML=`
            <div class="feedback-content">
                <div class="reference-translation">
                    <h4>📖 Reference Translation</h4>
                    <p><em>${t.referenceTranslation}</em></p>
                </div>
                <div class="ai-feedback">
                    <h4>🎯 AI Feedback</h4>
                    ${n}
                </div>
            </div>
        `,this.showResultsTabs("feedback")}displayMiniLesson(e){const t=document.getElementById("lesson-output");if(t){if(typeof e=="object"&&e.title)this.displayStructuredMiniLesson(e,t);else{const n=typeof marked<"u"&&marked.parse?marked.parse(e):e;t.innerHTML=`
                <div class="mini-lesson-content">
                    <h4>📚 Mini Lesson</h4>
                    ${n}
                </div>
            `}this.showResultsTabs("lesson")}}displayStructuredMiniLesson(e,t){const n=e.vocabulary.map(i=>`
            <div class="vocabulary-item">
                <strong>${i.word}</strong> - ${i.meaning}
                <div class="vocabulary-example"><em>${i.example}</em></div>
            </div>
        `).join(""),s=e.commonMistakes.map(i=>`
            <div class="mistake-item">
                <div class="mistake-pattern">❌ ${i.mistake}</div>
                <div class="mistake-correction">✅ ${i.correction}</div>
                <div class="mistake-example"><em>${i.example}</em></div>
            </div>
        `).join(""),a=e.exercises.map((i,c)=>`
            <div class="exercise-item" data-exercise-id="${c}">
                <div class="exercise-header">
                    <h5>Exercise ${c+1}: ${i.type.replace("-"," ").replace(/\b\w/g,r=>r.toUpperCase())}</h5>
                </div>
                <div class="exercise-instruction">${i.instruction}</div>
                <div class="exercise-question">${i.question}</div>
                <div class="exercise-answer-section">
                    <button class="show-answer-btn" onclick="app.toggleExerciseAnswer(${c})">
                        Show Answer
                    </button>
                    <div class="exercise-answer" id="exercise-answer-${c}" style="display: none;">
                        <div class="answer-text"><strong>Answer:</strong> ${i.answer}</div>
                        <div class="answer-explanation"><strong>Explanation:</strong> ${i.explanation}</div>
                    </div>
                </div>
            </div>
        `).join("");t.innerHTML=`
            <div class="structured-mini-lesson">
                <div class="lesson-header">
                    <h4>📚 ${e.title}</h4>
                </div>
                
                <div class="lesson-section grammar-section">
                    <h5>📖 Grammar Focus</h5>
                    <p>${e.grammarFocus}</p>
                </div>
                
                <div class="lesson-section vocabulary-section">
                    <h5>📝 Key Vocabulary</h5>
                    <div class="vocabulary-list">
                        ${n}
                    </div>
                </div>
                
                <div class="lesson-section mistakes-section">
                    <h5>⚠️ Common Mistakes</h5>
                    <div class="mistakes-list">
                        ${s}
                    </div>
                </div>
                
                <div class="lesson-section exercises-section">
                    <h5>💪 Practice Exercises</h5>
                    <div class="exercises-list">
                        ${a}
                    </div>
                </div>
            </div>
        `}generateSentenceInterface(e){const t=document.getElementById("sentence-translation-container");t&&(t.innerHTML="",e.forEach((n,s)=>{const a=document.createElement("div");a.className="sentence-pair",a.innerHTML=`
                <div class="sentence-original">
                    <span class="sentence-number">Sentence ${s+1}:</span>
                    ${n}
                </div>
                <textarea 
                    id="sentence-translation-${s}"
                    class="sentence-translation-input" 
                    placeholder="Type your translation here..."
                    rows="2"
                ></textarea>
            `,t.appendChild(a)}))}clear(){this.currentStory=null,this.currentSentences=[],this.referenceTranslation=null}showTranslationSection(){const e=document.getElementById("translation-section"),t=document.getElementById("results-tabs");if(e){e.style.display="block",this.currentSentences&&this.currentSentences.length>0&&this.generateSentenceInterface(this.currentSentences);const n=document.getElementById("feedback-output"),s=document.getElementById("lesson-output"),a=document.getElementById("mini-lesson-btn");n&&(n.innerHTML="",n.classList.remove("has-content")),s&&(s.innerHTML=""),a&&(a.style.display="none"),t&&(t.style.display="none")}}hideTranslationSection(){const e=document.getElementById("translation-section");e&&(e.style.display="none")}showResultsTabs(e="feedback"){const t=document.getElementById("results-tabs");if(t){t.style.display="block",this.switchTab(e);const n=document.getElementById("mini-lesson-btn");n&&(n.style.display="inline-block")}}switchTab(e){const t=document.getElementById("feedback-tab"),n=document.getElementById("lesson-tab");t&&n&&(t.classList.toggle("active",e==="feedback"),n.classList.toggle("active",e==="lesson"));const s=document.getElementById("feedback-tab-content"),a=document.getElementById("lesson-tab-content");s&&a&&(s.classList.toggle("active",e==="feedback"),a.classList.toggle("active",e==="lesson"));const i=document.getElementById("results-tabs");i&&i.scrollIntoView({behavior:"smooth",block:"nearest"})}}class E{constructor(e){this.geminiAPI=e,this.chatHistory=[],this.isOpen=!1,this.context=null}setContext(e){this.context=e}toggleChat(){const e=document.getElementById("chat-container"),t=document.getElementById("chat-toggle");if(!(!e||!t)&&(this.isOpen=!this.isOpen,this.isOpen&&this.updateContextFromCurrentState(),e.style.display=this.isOpen?"block":"none",t.textContent=this.isOpen?"✕":"💬",this.isOpen)){const n=document.getElementById("chat-input");n&&setTimeout(()=>n.focus(),100)}}async sendMessage(e){if(!e||e.trim().length===0)return;const t=e.trim();try{this.addMessageToChat(t,"user");const n=document.getElementById("chat-input");n&&(n.value=""),this.showTypingIndicator(),this.updateContextFromCurrentState();const s=await this.geminiAPI.chat(t,this.formatContextForAI());this.hideTypingIndicator(),this.addMessageToChat(s,"bot"),this.chatHistory.push({role:"user",message:t},{role:"bot",message:s})}catch(n){this.hideTypingIndicator(),this.addMessageToChat("Sorry, I encountered an error. Please try again.","bot"),console.error("Chat error:",n)}}addMessageToChat(e,t){const n=document.getElementById("chat-messages");if(!n)return;const s=document.createElement("div");s.classList.add("chat-message",`${t}-message`),t==="bot"?s.innerHTML=typeof marked<"u"&&marked.parse?marked.parse(e):e:s.textContent=e,n.appendChild(s),this.scrollToBottom()}scrollToBottom(){const e=document.getElementById("chat-messages");e&&setTimeout(()=>{e.scrollTop=e.scrollHeight},100)}showTypingIndicator(){const e=document.getElementById("chat-messages");if(!e)return;const t=document.createElement("div");t.classList.add("chat-message","bot-message","typing-indicator"),t.innerHTML='<span class="typing-dots">●●●</span>',t.id="typing-indicator",e.appendChild(t),this.scrollToBottom()}hideTypingIndicator(){const e=document.getElementById("typing-indicator");e&&e.remove()}handleKeyPress(e){const t=e.target;t.style.height="auto",t.style.height=Math.min(t.scrollHeight,100)+"px",e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage(t.value))}clearChat(){this.chatHistory=[];const e=document.getElementById("chat-messages");e&&(e.innerHTML="")}initializeChat(){this.addMessageToChat(`Hello! I'm your AI language learning assistant. I can help you with:

• Grammar questions
• Vocabulary explanations
• Translation help
• Language learning tips

What would you like to know?`,"bot")}updateContextFromCurrentState(){const e={timestamp:Date.now(),sourceLanguage:null,targetLanguage:null,currentStory:null,sentences:[],userTranslations:[],feedback:null,miniLesson:null},t=document.getElementById("source-lang"),n=document.getElementById("target-lang");t&&n&&(e.sourceLanguage=t.value,e.targetLanguage=n.value);const s=document.getElementById("story-output");s&&s.textContent&&s.classList.contains("has-content")&&(e.currentStory=s.textContent.trim());const a=document.getElementById("sentence-translation-container");a&&a.children.length>0&&Array.from(a.children).forEach((o,m)=>{const l=o.querySelector(".sentence-original"),d=o.querySelector(".sentence-translation-input");if(l&&d){const g=l.textContent.replace(/^Sentence \d+:\s*/,"").trim(),h=d.value.trim();e.sentences.push(g),h&&e.userTranslations.push({sentenceIndex:m,original:g,translation:h})}});const i=document.getElementById("feedback-output");if(i&&i.innerHTML.trim()){const r=document.createElement("div");r.innerHTML=i.innerHTML,e.feedback=r.textContent.trim()}const c=document.getElementById("lesson-output");if(c&&c.innerHTML.trim()){const r=document.createElement("div");r.innerHTML=c.innerHTML,e.miniLesson=r.textContent.trim()}this.context=e}formatContextForAI(){if(!this.context)return null;let e=`CURRENT SESSION CONTEXT:

`;return this.context.sourceLanguage&&this.context.targetLanguage&&(e+=`Learning languages: ${this.context.sourceLanguage} → ${this.context.targetLanguage}

`),this.context.currentStory&&(e+=`STORY TO TRANSLATE:
${this.context.currentStory}

`),this.context.userTranslations&&this.context.userTranslations.length>0&&(e+=`USER'S TRANSLATION ATTEMPTS:
`,this.context.userTranslations.forEach((t,n)=>{e+=`${n+1}. Original: "${t.original}"
   User translation: "${t.translation}"
`}),e+=`
`),this.context.feedback&&(e+=`CURRENT FEEDBACK:
${this.context.feedback}

`),this.context.miniLesson&&(e+=`CURRENT MINI LESSON:
${this.context.miniLesson}

`),e===`CURRENT SESSION CONTEXT:

`?null:(e+="Please help the user based on their current learning session context above.",e)}updateContextWithStory(e,t,n){this.context={currentStory:e,sourceLanguage:t,targetLanguage:n,timestamp:Date.now()}}closeChat(){this.isOpen&&this.toggleChat()}}function w(u){const e=v[u];return!e||e.length===0?"general situation":e[Math.floor(Math.random()*e.length)]}function k(u){return{daily_life:"Daily Life",travel:"Travel & Adventure",food:"Food & Cooking",friendship:"Friendship & Relationships",work:"Work & Career",shopping:"Shopping & Money",health:"Health & Wellness",hobbies:"Hobbies & Entertainment",family:"Family & Home",nature:"Nature & Environment",technology:"Technology & Modern Life",education:"Education & Learning",custom:"Custom Theme"}[u]||u}function I(u){if(!u||typeof u!="string")return{valid:!1,error:"Custom theme is required"};const e=u.trim();return e.length<3?{valid:!1,error:"Custom theme must be at least 3 characters"}:e.length>100?{valid:!1,error:"Custom theme must be less than 100 characters"}:{valid:!0,theme:e}}function C(u,e=null){if(u==="custom"){const t=I(e);if(!t.valid)throw new Error(t.error);return{theme:t.theme,variant:"custom story scenario"}}return{theme:k(u),variant:w(u)}}class T{constructor(){this.currentStory=null,this.currentSentences=[],this.sourceLanguage=p.sourceLanguage,this.targetLanguage=p.targetLanguage,this.apiKey=null,this.selectedModel=p.model,this.geminiAPI=null,this.translationManager=null,this.chatManager=null}async initialize(){console.log("🚀 Initializing Get Fluent Now App..."),this.setupEventListeners(),this.initializeApiConfig();const e=localStorage.getItem("gemini_api_key");e?(document.getElementById("gemini-api-key").value=e,await this.validateApiKey()):this.updateStatus("🔑 Please enter your Gemini API key to enable AI features"),document.getElementById("app-controls").style.display="block",this.initializeThemeSelector()}setupEventListeners(){const e=document.getElementById("story-theme");e&&e.addEventListener("change",()=>this.handleThemeChange());const t=document.getElementById("chat-input");t&&t.addEventListener("keypress",i=>this.handleChatKeyPress(i));const n=document.getElementById("source-lang"),s=document.getElementById("target-lang");n&&n.addEventListener("change",()=>this.updateLanguages()),s&&s.addEventListener("change",()=>this.updateLanguages()),document.querySelectorAll('input[name="model"]').forEach(i=>{i.addEventListener("change",()=>this.updateModel())})}initializeApiConfig(){localStorage.getItem("gemini_api_key")?this.updateApiConfigStatus(!0,!1):this.updateApiConfigStatus(!1,!0)}toggleApiSection(){const e=document.getElementById("api-header"),t=document.getElementById("api-content"),n=document.getElementById("api-toggle-icon");if(!e||!t||!n)return;t.classList.contains("expanded")?(t.classList.remove("expanded"),e.classList.add("collapsed"),n.textContent="▶"):(t.classList.add("expanded"),e.classList.remove("collapsed"),n.textContent="▼")}updateApiConfigStatus(e,t=!1){const n=document.getElementById("api-status-indicator"),s=document.getElementById("api-header-text"),a=document.getElementById("api-content"),i=document.getElementById("api-header"),c=document.getElementById("api-toggle-icon");!n||!s||!a||!i||!c||(e?(n.classList.remove("required"),n.classList.add("configured"),n.textContent="✅",s.textContent="API Configuration (Ready)",t||(a.classList.remove("expanded"),i.classList.add("collapsed"),c.textContent="▶")):(n.classList.remove("configured"),n.classList.add("required"),n.textContent="🔑",s.textContent="API Configuration (Required)",a.classList.add("expanded"),i.classList.remove("collapsed"),c.textContent="▼"))}initializeThemeSelector(){const e=document.getElementById("story-theme"),t=document.getElementById("custom-theme-container");e&&t&&(t.style.display=e.value==="custom"?"block":"none")}updateStatus(e){const t=document.getElementById("status");t&&(t.textContent=e)}async validateApiKey(){const e=document.getElementById("gemini-api-key");if(!e)return;const t=e.value.trim();if(!t){this.updateStatus("❌ Please enter your Gemini API key");return}this.updateStatus("🔄 Validating API key...");try{const n=new b(t,this.selectedModel),s=await n.validateApiKey();s.valid?(this.apiKey=t,localStorage.setItem("gemini_api_key",t),this.geminiAPI=n,this.translationManager=new S(this.geminiAPI),this.chatManager=new E(this.geminiAPI),this.chatManager.initializeChat(),this.updateApiConfigStatus(!0),this.updateStatus("✅ API key validated! Ready to generate stories")):(this.updateStatus(`❌ ${s.error}`),this.updateApiConfigStatus(!1,!0))}catch(n){console.error("API validation error:",n),this.updateStatus("❌ Failed to validate API key")}}updateModel(){const e=document.querySelectorAll('input[name="model"]');for(const t of e)if(t.checked&&this.geminiAPI){this.selectedModel=t.value,this.geminiAPI.setModel(this.selectedModel);break}}updateLanguages(){const e=document.getElementById("source-lang"),t=document.getElementById("target-lang");if(e&&t){if(this.sourceLanguage=e.value,this.targetLanguage=t.value,this.sourceLanguage===this.targetLanguage){this.updateStatus("⚠️ Source and target languages must be different");return}this.currentStory&&this.chatManager&&this.chatManager.updateContextWithStory(this.currentStory,this.sourceLanguage,this.targetLanguage)}}swapLanguages(){const e=document.getElementById("source-lang"),t=document.getElementById("target-lang");if(e&&t){const n=e.value;e.value=t.value,t.value=n,this.updateLanguages()}}handleThemeChange(){const e=document.getElementById("story-theme"),t=document.getElementById("custom-theme-container");if(e&&t){const n=e.value==="custom";if(t.style.display=n?"block":"none",n){const s=document.getElementById("custom-theme-input");s&&s.focus()}}}async generateStory(){if(!this.geminiAPI){this.updateStatus("❌ Please validate your API key first");return}const e=document.getElementById("difficulty-level"),t=document.getElementById("story-theme"),n=document.getElementById("custom-theme-input"),s=document.getElementById("story-output"),a=document.getElementById("generate-story-btn");if(!e||!t||!s||!a)return;const i=e.value,c=t.value,r=n?n.value:null;try{a.textContent="⏳ Generating...",a.disabled=!0,s.textContent="Generating your story...",this.updateStatus("✨ Generating story...");const o=C(c,r),m=await this.geminiAPI.generateStructuredStory(y[this.sourceLanguage],i,o.theme,o.variant);this.currentStory=m.join(" "),this.currentSentences=m,s.textContent=this.currentStory,s.classList.add("has-content"),this.translationManager.setCurrentSentences(m),this.translationManager.showTranslationSection(),this.chatManager.updateContextWithStory(this.currentStory,this.sourceLanguage,this.targetLanguage),this.updateStatus("✅ Story generated! Translate it to practice")}catch(o){console.error("Story generation error:",o),this.updateStatus("❌ Failed to generate story"),s.textContent=`Error: ${o.message}`}finally{a.textContent="✨ Generate New Story",a.disabled=!1}}async submitTranslation(){if(!this.translationManager){this.updateStatus("❌ Translation manager not initialized");return}const e=document.getElementById("translation-input"),t=document.getElementById("submit-translation-btn"),n=document.getElementById("feedback-output"),s=document.getElementById("mini-lesson-btn");if(!e||!t||!n)return;const a=e.value.trim();try{t.textContent="⏳ Getting feedback...",t.disabled=!0,n.textContent="Analyzing your translation...",this.updateStatus("🔍 Analyzing your translation...");const i=await this.translationManager.processTranslation(a,this.sourceLanguage,this.targetLanguage);this.translationManager.displayFeedback(n,i),s&&(s.style.display="inline-block"),this.updateStatus("✅ Feedback provided! Check your translation")}catch(i){console.error("Translation submission error:",i),this.updateStatus("❌ Failed to process translation"),n.textContent=`Error: ${i.message}`}finally{t.textContent="🎯 Get Feedback",t.disabled=!1}}async submitSentenceTranslations(){if(!this.translationManager){this.updateStatus("❌ Translation manager not initialized");return}const e=document.getElementById("submit-translation-btn"),t=document.getElementById("feedback-output"),n=document.getElementById("mini-lesson-btn");if(!(!e||!t))try{e.textContent="⏳ Getting feedback...",e.disabled=!0,t.textContent="Analyzing your translations...",this.updateStatus("🔍 Analyzing your translations...");const s=await this.translationManager.processSentenceTranslations(this.sourceLanguage,this.targetLanguage);this.translationManager.displaySentenceFeedback(t,s),n&&(n.style.display="inline-block"),this.updateStatus("✅ Feedback provided! Check your translations")}catch(s){console.error("Sentence translation submission error:",s),this.updateStatus("❌ Failed to process translations"),t.textContent=`Error: ${s.message}`}finally{e.textContent="🎯 Get Feedback",e.disabled=!1}}async generateMiniLesson(){if(!this.translationManager)return;const e=document.getElementById("mini-lesson-btn"),t=[];if(this.currentSentences&&this.currentSentences.length>0)for(let n=0;n<this.currentSentences.length;n++){const s=document.getElementById(`sentence-translation-${n}`);s&&s.value.trim()&&t.push({original:this.currentSentences[n],translation:s.value.trim()})}if(t.length===0){this.updateStatus("❌ Please translate at least one sentence first");return}try{e&&(e.textContent="⏳ Creating lesson...",e.disabled=!0),this.updateStatus("📚 Creating personalized lesson...");const n=await this.translationManager.generateSentenceMiniLesson(t,this.sourceLanguage,this.targetLanguage);this.translationManager.displayMiniLesson(n),this.updateStatus("✅ Mini lesson ready!")}catch(n){console.error("Mini lesson error:",n),this.updateStatus("❌ Failed to generate lesson")}finally{e&&(e.textContent="📚 Mini Lesson",e.disabled=!1)}}toggleChat(){this.chatManager&&this.chatManager.toggleChat()}async sendChatMessage(){if(!this.chatManager)return;const e=document.getElementById("chat-input");e&&await this.chatManager.sendMessage(e.value)}handleChatKeyPress(e){this.chatManager&&this.chatManager.handleKeyPress(e)}minimizeChat(){const e=document.getElementById("chat-container");if(e){e.classList.toggle("minimized");const t=document.getElementById("chat-minimize");t&&(t.textContent=e.classList.contains("minimized")?"□":"−",t.title=e.classList.contains("minimized")?"Restore":"Minimize")}}clearChat(){this.chatManager&&(this.chatManager.clearChat(),this.chatManager.initializeChat())}showApiHelp(){const e=document.getElementById("help-modal");e&&(e.style.display="flex")}closeApiHelp(){const e=document.getElementById("help-modal");e&&(e.style.display="none")}switchTab(e){this.translationManager&&this.translationManager.switchTab(e)}toggleExerciseAnswer(e){const t=document.getElementById(`exercise-answer-${e}`),n=document.querySelector(`[onclick="app.toggleExerciseAnswer(${e})"]`);if(t&&n){const s=t.style.display==="none";t.style.display=s?"block":"none",n.textContent=s?"Hide Answer":"Show Answer",n.classList.toggle("answer-shown",s)}}}document.addEventListener("DOMContentLoaded",()=>{window.app=new T,window.app.initialize()});

</script>
  <style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;line-height:1.6;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;color:#333}#main-container{max-width:900px;margin:0 auto;padding:20px;min-height:100vh}#header{text-align:center;margin-bottom:30px;color:#fff}#main-title{font-size:2.5rem;font-weight:700;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}#subtitle{font-size:1.1rem;opacity:.9;font-weight:300}.section-card{background:#fff;border-radius:12px;padding:25px;margin-bottom:20px;box-shadow:0 4px 6px #0000001a;border:1px solid #e5e7eb}#status{background:#fff;padding:15px 20px;border-radius:8px;margin-bottom:20px;text-align:center;font-weight:500;border:2px solid #e5e7eb}.config-section{background:#fff;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 6px #0000001a;border:1px solid #e5e7eb;overflow:hidden}.config-header{display:flex;align-items:center;gap:12px;padding:20px 25px;cursor:pointer;-webkit-user-select:none;user-select:none;transition:background-color .2s ease;border-bottom:1px solid #f3f4f6}.config-header:hover{background-color:#f9fafb}.status-indicator{font-size:1.2rem;min-width:24px;text-align:center}.status-indicator.required{color:#dc2626;animation:pulse 2s infinite}.status-indicator.configured{color:#16a34a}@keyframes pulse{0%,to{opacity:1}50%{opacity:.6}}.config-header span{font-weight:600;color:#374151;flex:1}.toggle-icon{transition:transform .2s ease;color:#6b7280}.config-header.collapsed .toggle-icon{transform:rotate(-90deg)}.config-content{padding:0 25px;max-height:0;overflow:hidden;transition:max-height .3s ease,padding .3s ease}.config-content.expanded{max-height:600px;padding:25px}#api-input-container{display:flex;gap:10px;align-items:center;flex-wrap:wrap}#gemini-api-key{flex:1;min-width:250px;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb}#gemini-api-key:focus{outline:none;border-color:#667eea;background:#fff}button{padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;white-space:nowrap}#validate-key-btn,#generate-story-btn,#submit-translation-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}#validate-key-btn:hover,#generate-story-btn:hover,#submit-translation-btn:hover{background:linear-gradient(135deg,#5a6fd8,#6a4190);transform:translateY(-2px);box-shadow:0 4px 12px #667eea66}#help-btn,#swap-languages,#mini-lesson-btn{background:#f3f4f6;color:#374151;border:2px solid #e5e7eb}#help-btn:hover,#swap-languages:hover,#mini-lesson-btn:hover{background:#e5e7eb;border-color:#d1d5db}#swap-languages{margin-top:20px;width:100%;font-size:15px;padding:15px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;box-shadow:0 2px 4px #667eea4d}#swap-languages:hover{background:linear-gradient(135deg,#5a6fd8,#6a4190);transform:translateY(-1px);box-shadow:0 4px 8px #667eea66}#app-controls{display:grid;gap:20px}#model-section,#difficulty-section,#theme-section,#language-section{background:#fff;border-radius:12px;padding:25px;box-shadow:0 4px 6px #0000001a;border:1px solid #e5e7eb}#language-controls{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:10px}h3{margin-bottom:15px;color:#374151;font-size:1.1rem;font-weight:600}label{display:block;margin-bottom:8px;font-weight:500;color:#374151}select{width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;background:#fff;color:#374151;cursor:pointer}select:focus{outline:none;border-color:#667eea}#model-options{display:flex;flex-direction:row;gap:15px;flex-wrap:wrap}.radio-option{display:flex;align-items:center;padding:12px 16px;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s;background:#f9fafb;flex:1;min-width:140px;justify-content:center;text-align:center}.radio-option:hover{border-color:#d1d5db;background:#f3f4f6}.radio-option input[type=radio]{margin-right:8px;accent-color:#667eea;cursor:pointer}.radio-option input[type=radio]:checked+.radio-label{color:#374151;font-weight:600}.radio-option:has(input:checked){border-color:#667eea;background:#f0f9ff}.radio-label{display:flex;flex-direction:column;gap:2px;font-size:13px}.radio-label strong{color:#374151;font-size:13px;font-weight:600}.radio-label small{color:#6b7280;font-size:11px;font-weight:400}#custom-theme-input{width:100%;padding:12px 15px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;margin-top:10px;background:#f9fafb}#custom-theme-input:focus{outline:none;border-color:#667eea;background:#fff}#story-section{background:#fff;border-radius:12px;padding:25px;box-shadow:0 4px 6px #0000001a;border:1px solid #e5e7eb}#generate-story-btn{width:100%;font-size:16px;padding:15px;margin-bottom:20px}#story-output{background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;padding:20px;margin-top:15px;font-size:16px;line-height:1.8;color:#2d3748;min-height:100px}#story-output.has-content{background:#fff;border-color:#667eea}#translation-section{background:#fff;border-radius:12px;padding:25px;box-shadow:0 4px 6px #0000001a;border:1px solid #e5e7eb}#sentence-translation-container{display:flex;flex-direction:column;gap:20px;margin-bottom:25px}.sentence-pair{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:12px}.sentence-original{background:#fff;border:1px solid #cbd5e0;border-radius:8px;padding:15px;color:#2d3748;font-style:italic;line-height:1.5;border-left:4px solid #4299e1}.sentence-original .sentence-number{color:#4299e1;font-weight:700;font-size:.9rem;display:block;margin-bottom:8px}.sentence-translation-input{width:100%;padding:15px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;font-family:inherit;resize:vertical;min-height:60px;transition:border-color .2s ease}.sentence-translation-input:focus{outline:none;border-color:#4299e1;box-shadow:0 0 0 3px #4299e11a}.sentence-translation-input::placeholder{color:#a0aec0;font-style:italic}.sentence-feedback-item{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:20px;border-left:4px solid #4299e1}.sentence-feedback-item h5{color:#4299e1;font-size:1.1rem;margin-bottom:15px;font-weight:700}.sentence-feedback-original,.sentence-feedback-user,.sentence-feedback-reference{margin-bottom:10px;padding:10px;border-radius:6px;background:#f7fafc}.sentence-feedback-original{border-left:3px solid #cbd5e0}.sentence-feedback-user{border-left:3px solid #f6ad55}.sentence-feedback-reference{border-left:3px solid #68d391}.sentence-feedback-content{margin-top:15px;padding:15px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}.overall-feedback{background:#edf2f7;border:1px solid #cbd5e0;border-radius:12px;padding:20px;margin-bottom:25px}.overall-feedback h4{color:#2d3748;margin-bottom:15px}#translation-input{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;line-height:1.6;resize:vertical;font-family:inherit;margin-bottom:15px}#translation-input:focus{outline:none;border-color:#667eea}#translation-controls{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px}#feedback-output{background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;padding:20px;margin-top:15px;line-height:1.6}#feedback-output.has-content{background:#fff;border-color:#10b981}#feedback-output h1,#feedback-output h2,#feedback-output h3,#feedback-output h4,#feedback-output h5,#feedback-output h6{color:#374151;margin:20px 0 12px;font-weight:600;line-height:1.3}#feedback-output h1{font-size:1.8rem}#feedback-output h2{font-size:1.5rem}#feedback-output h3{font-size:1.3rem}#feedback-output h4{font-size:1.1rem}#feedback-output h5{font-size:1rem}#feedback-output h6{font-size:.9rem}#feedback-output p{margin:12px 0;line-height:1.6}#feedback-output ul,#feedback-output ol{margin:12px 0 12px 20px;line-height:1.6}#feedback-output li{margin:6px 0}#feedback-output strong{font-weight:600;color:#374151}#feedback-output em{font-style:italic;color:#6b7280}#feedback-output code{background:#f3f4f6;padding:2px 6px;border-radius:4px;font-family:SF Mono,Monaco,Cascadia Code,monospace;font-size:.9em}#feedback-output blockquote{border-left:4px solid #e5e7eb;margin:16px 0;padding:8px 16px;background:#f9fafb;font-style:italic}#results-tabs{margin-top:20px}#tab-buttons{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:0;gap:0}.tab-button{padding:12px 20px;border:none;border-bottom:3px solid transparent;background:#f9fafb;color:#6b7280;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;border-radius:8px 8px 0 0;margin-right:4px}.tab-button:hover{background:#f3f4f6;color:#374151}.tab-button.active{background:#fff;color:#667eea;border-bottom-color:#667eea;font-weight:600}#tab-content{background:#fff;border:2px solid #e5e7eb;border-top:none;border-radius:0 0 8px 8px;min-height:200px}.tab-panel{display:none;padding:20px}.tab-panel.active{display:block}#feedback-output,#lesson-output{background:transparent;border:none;padding:0;margin:0;min-height:auto}#lesson-output h1,#lesson-output h2,#lesson-output h3,#lesson-output h4,#lesson-output h5,#lesson-output h6{color:#374151;margin:20px 0 12px;font-weight:600;line-height:1.3}#lesson-output h1{font-size:1.8rem}#lesson-output h2{font-size:1.5rem}#lesson-output h3{font-size:1.3rem}#lesson-output h4{font-size:1.1rem}#lesson-output h5{font-size:1rem}#lesson-output h6{font-size:.9rem}#lesson-output p{margin:12px 0;line-height:1.6}#lesson-output ul,#lesson-output ol{margin:12px 0 12px 20px;line-height:1.6}#lesson-output li{margin:6px 0}#lesson-output strong{font-weight:600;color:#374151}#lesson-output em{font-style:italic;color:#6b7280}#lesson-output code{background:#f3f4f6;padding:2px 6px;border-radius:4px;font-family:SF Mono,Monaco,Cascadia Code,monospace;font-size:.9em}#lesson-output blockquote{border-left:4px solid #e5e7eb;margin:16px 0;padding:8px 16px;background:#f9fafb;font-style:italic}#chat-widget{position:fixed;bottom:30px;right:30px;z-index:1000}#chat-toggle{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;box-shadow:0 4px 12px #00000026;transition:all .3s ease;border:none}#chat-toggle:hover{transform:scale(1.1);box-shadow:0 6px 20px #0003}#chat-container{position:absolute;bottom:80px;right:0;width:400px;height:500px;min-width:300px;min-height:300px;max-width:600px;max-height:80vh;background:#fff;border-radius:16px;box-shadow:0 12px 40px #00000026;display:flex;flex-direction:column;border:1px solid #e5e7eb;resize:both;overflow:auto}#chat-container.minimized{height:50px}#chat-container.minimized #chat-body{display:none}#chat-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10;cursor:move;-webkit-user-select:none;user-select:none}#chat-header-content{padding:15px 20px;display:flex;justify-content:space-between;align-items:center}#chat-header h4{margin:0;font-size:16px;font-weight:600}#chat-controls{display:flex;gap:8px;align-items:center}#chat-controls button{background:#fff3;border:none;color:#fff;width:28px;height:28px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:background-color .2s ease}#chat-controls button:hover{background:#ffffff4d}#chat-resize-handle{position:absolute;bottom:-2px;right:-2px;width:16px;height:16px;background:#ffffff4d;cursor:se-resize;border-radius:0 0 16px}#chat-resize-handle:hover{background:#ffffff80}#chat-body{display:flex;flex-direction:column;flex:1;min-height:0}#chat-messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}#chat-messages::-webkit-scrollbar{width:6px}#chat-messages::-webkit-scrollbar-track{background:#f1f5f9}#chat-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}#chat-messages::-webkit-scrollbar-thumb:hover{background:#94a3b8}.chat-message{max-width:85%;padding:12px 16px;border-radius:16px;line-height:1.5;font-size:14px;word-wrap:break-word;animation:fadeIn .3s ease}@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.user-message{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;margin-left:auto}.bot-message{background:#f8fafc;color:#334155;align-self:flex-start;border-bottom-left-radius:4px;border:1px solid #e2e8f0}.bot-message h1,.bot-message h2,.bot-message h3,.bot-message h4,.bot-message h5,.bot-message h6{font-size:15px;font-weight:600;margin:10px 0 6px;color:#1e293b}.bot-message p{margin:6px 0;line-height:1.6}.bot-message ul,.bot-message ol{margin:8px 0;padding-left:20px}.bot-message li{margin:4px 0;line-height:1.5}.bot-message strong{font-weight:600;color:#1e293b}.bot-message em{font-style:italic;color:#475569}.bot-message code{background:#e2e8f0;color:#1e293b;padding:2px 6px;border-radius:4px;font-size:13px;font-family:SF Mono,Monaco,Inconsolata,Roboto Mono,monospace}.bot-message pre{background:#f1f5f9;padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0;border-left:3px solid #667eea}.typing-indicator{align-self:flex-start;background:#f8fafc;border:1px solid #e2e8f0}.typing-dots{animation:typing 1.4s infinite;font-size:18px;color:#64748b}@keyframes typing{0%,60%,to{opacity:.4}30%{opacity:1}}#chat-input-container{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;gap:12px;align-items:flex-end;background:#fafbfc}#chat-input{flex:1;padding:12px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:14px;resize:none;font-family:inherit;line-height:1.5;min-height:20px;max-height:100px;overflow-y:auto;transition:border-color .2s ease;background:#fff}#chat-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px #667eea1a}#chat-input::-webkit-scrollbar{width:4px}#chat-input::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:2px}#chat-send-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 20px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s ease;min-width:70px;box-shadow:0 2px 8px #667eea4d}#chat-send-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px #667eea66}#chat-send-btn:active{transform:translateY(0)}#chat-send-btn:disabled{background:#94a3b8;cursor:not-allowed;transform:none;box-shadow:none}.structured-mini-lesson{background:#fff;border-radius:12px;overflow:hidden}.lesson-header h4{color:#1e293b;font-size:1.25rem;font-weight:600;margin:0 0 20px;padding-bottom:12px;border-bottom:2px solid #e2e8f0}.lesson-section{margin-bottom:24px}.lesson-section h5{color:#334155;font-size:1.1rem;font-weight:600;margin:0 0 12px;display:flex;align-items:center;gap:8px}.grammar-section p{color:#475569;line-height:1.6;background:#f8fafc;padding:16px;border-radius:8px;border-left:4px solid #3b82f6}.vocabulary-list{display:flex;flex-direction:column;gap:12px}.vocabulary-item{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:14px;border-left:4px solid #0ea5e9}.vocabulary-item strong{color:#0c4a6e;font-size:1.05em}.vocabulary-example{color:#0369a1;font-size:.9em;margin-top:6px;font-style:italic}.mistakes-list{display:flex;flex-direction:column;gap:12px}.mistake-item{background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:14px;border-left:4px solid #ef4444}.mistake-pattern{color:#dc2626;font-weight:500;margin-bottom:4px}.mistake-correction{color:#059669;font-weight:500;margin-bottom:4px}.mistake-example{color:#374151;font-size:.9em;font-style:italic}.exercises-list{display:flex;flex-direction:column;gap:16px}.exercise-item{background:#f9fafb;border:2px solid #e5e7eb;border-radius:12px;padding:20px;transition:border-color .2s ease}.exercise-item:hover{border-color:#d1d5db}.exercise-header h5{color:#1f2937;font-size:1rem;font-weight:600;margin:0 0 10px}.exercise-instruction{color:#6b7280;font-size:.9em;margin-bottom:12px;font-style:italic}.exercise-question{color:#1f2937;font-size:1rem;font-weight:500;background:#fff;padding:16px;border-radius:8px;border:1px solid #d1d5db;margin-bottom:16px;line-height:1.5}.exercise-answer-section{display:flex;flex-direction:column;gap:12px}.show-answer-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:500;transition:all .2s ease;align-self:flex-start}.show-answer-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px #667eea4d}.show-answer-btn.answer-shown{background:#6b7280}.show-answer-btn.answer-shown:hover{background:#4b5563}.exercise-answer{background:#ecfdf5;border:2px solid #a7f3d0;border-radius:8px;padding:16px;border-left:4px solid #10b981}.answer-text{color:#065f46;font-weight:600;margin-bottom:8px}.answer-explanation{color:#047857;line-height:1.5}#help-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000000b3;z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px}#help-content{background:#fff;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 40px #00000026}#help-header{padding:25px 25px 15px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}#help-header h2{margin:0;color:#374151;font-size:1.5rem}#close-help{background:#f3f4f6;border:none;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px;color:#6b7280}#help-steps{padding:25px}.help-step{margin-bottom:25px}.help-step h3{color:#667eea;margin-bottom:8px;font-size:1.1rem}.help-step p{color:#6b7280;margin-bottom:5px}.help-step a{color:#667eea;text-decoration:none;font-weight:500}.help-step a:hover{text-decoration:underline}.help-note{background:#f0f9ff;border:1px solid #e0f2fe;border-radius:8px;padding:15px;margin-top:20px}.help-note p{color:#0369a1;margin-bottom:5px;font-size:14px}@media (max-width: 768px){#main-container{padding:15px}#main-title{font-size:2rem}#language-controls{grid-template-columns:1fr;gap:15px}#api-input-container{flex-direction:column;align-items:stretch}.config-header{padding:15px 20px;gap:10px}.config-content.expanded{padding:20px}.status-indicator{min-width:20px}#gemini-api-key{min-width:unset}#translation-controls{flex-direction:column}#model-options{flex-direction:column;gap:10px}.radio-option{min-width:unset;justify-content:flex-start}#chat-container{width:calc(100vw - 40px);right:-15px;height:350px}#chat-widget{right:15px;bottom:15px}#chat-container{width:95vw;max-width:350px;height:70vh;max-height:500px;right:-15px;bottom:70px}#chat-header-content{padding:12px 16px}#chat-controls button{width:24px;height:24px;font-size:12px}#chat-messages{padding:16px;gap:10px}#chat-input-container{padding:12px 16px;gap:10px}#chat-input{padding:10px 14px;font-size:16px}#chat-send-btn{padding:10px 16px;min-width:60px}#help-content{margin:10px;max-height:90vh}}@media (max-width: 480px){#main-container{padding:10px}.section-card,#api-section,#model-section,#language-section,#difficulty-section,#theme-section,#story-section,#translation-section{padding:20px}#main-title{font-size:1.8rem}#subtitle{font-size:1rem}}

</style>
</head>
<body>
    <!-- Main Container -->
    <div id="main-container">
        <!-- Header Section -->
        <div id="header">
            <h1 id="main-title">Get Fluent Now 🌍</h1>
            <p id="subtitle">AI-powered language learning with Google Gemini</p>
        </div>

        <!-- Status Display -->
        <div id="status">🔑 Please enter your Gemini API key to enable AI chat</div>

        <!-- API Configuration Section -->
        <div id="api-section" class="config-section">
            <div id="api-header" class="config-header" onclick="app.toggleApiSection()">
                <span id="api-status-indicator" class="status-indicator required">🔑</span>
                <span id="api-header-text">API Configuration</span>
                <span id="api-toggle-icon" class="toggle-icon">▼</span>
            </div>
            <div id="api-content" class="config-content expanded">
                <div id="api-input-container">
                    <input 
                        type="password" 
                        id="gemini-api-key" 
                        placeholder="Enter your Gemini API key" 
                        autocomplete="off"
                    >
                    <button id="validate-key-btn" onclick="app.validateApiKey()">Validate Key</button>
                    <button id="help-btn" onclick="app.showApiHelp()">❓ Get API Key</button>
                </div>
                <!-- Model Selection -->
                <div id="model-section">
                    <h3>🧠 AI Model</h3>
                    <div id="model-options">
                        <label class="radio-option">
                            <input type="radio" name="model" value="flash-lite" checked onchange="app.updateModel()">
                            <span class="radio-label">
                                <strong>Gemini 2.5 Flash Lite</strong>
                                <small>Latest model, fastest and most cost-effective</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="model" value="flash" onchange="app.updateModel()">
                            <span class="radio-label">
                                <strong>Gemini 2.5 Flash</strong>
                                <small>Best price/performance, advanced capabilities</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="model" value="pro" onchange="app.updateModel()">
                            <span class="radio-label">
                                <strong>Gemini 1.5 Pro</strong>
                                <small>Highest quality, slower</small>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- App Controls -->
        <div id="app-controls" style="display: none;">

            <!-- Language Configuration -->
            <div id="language-section">
                <div id="language-controls">
                    <div id="source-lang-control">
                        <label for="source-lang">📚 Story Language:</label>
                        <select id="source-lang" onchange="app.updateLanguages()">
                            <option value="Spanish">Spanish (español)</option>
                            <option value="French">French (français)</option>
                            <option value="Italian">Italian (italiano)</option>
                            <option value="German">German (Deutsch)</option>
                            <option value="Portuguese">Portuguese (português)</option>
                            <option value="Dutch">Dutch (Nederlands)</option>
                            <option value="Russian">Russian (русский)</option>
                            <option value="Japanese">Japanese (日本語)</option>
                            <option value="Korean">Korean (한국어)</option>
                            <option value="Chinese (Simplified)">Chinese (中文)</option>
                            <option value="Arabic">Arabic (العربية)</option>
                            <option value="English">English</option>
                        </select>
                    </div>
                    <div id="target-lang-control">
                        <label for="target-lang">🎯 Translate to:</label>
                        <select id="target-lang" onchange="app.updateLanguages()">
                            <option value="English">English</option>
                            <option value="Spanish">Spanish (español)</option>
                            <option value="French">French (français)</option>
                            <option value="Italian">Italian (italiano)</option>
                            <option value="German">German (Deutsch)</option>
                            <option value="Portuguese">Portuguese (português)</option>
                            <option value="Dutch">Dutch (Nederlands)</option>
                            <option value="Russian">Russian (русский)</option>
                            <option value="Japanese">Japanese (日本語)</option>
                            <option value="Korean">Korean (한국어)</option>
                            <option value="Chinese (Simplified)">Chinese (中文)</option>
                            <option value="Arabic">Arabic (العربية)</option>
                        </select>
                    </div>
                </div>
                <button id="swap-languages" onclick="app.swapLanguages()">🔄 Swap Languages</button>
            </div>

            <!-- Difficulty Level -->
            <div id="difficulty-section">
                <h3>📊 Difficulty Level (CEFR)</h3>
                <select id="difficulty-level">
                    <option value="A1">A1 - Complete Beginner</option>
                    <option value="A2">A2 - Elementary</option>
                    <option value="B1">B1 - Intermediate</option>
                    <option value="B2">B2 - Upper Intermediate</option>
                    <option value="C1">C1 - Advanced</option>
                </select>
            </div>

            <!-- Theme Selection -->
            <div id="theme-section">
                <h3>🎨 Story Theme</h3>
                <select id="story-theme">
                    <option value="daily_life">Daily Life</option>
                    <option value="travel">Travel & Adventure</option>
                    <option value="food">Food & Cooking</option>
                    <option value="friendship">Friendship & Relationships</option>
                    <option value="work">Work & Career</option>
                    <option value="shopping">Shopping & Money</option>
                    <option value="health">Health & Wellness</option>
                    <option value="hobbies">Hobbies & Entertainment</option>
                    <option value="family">Family & Home</option>
                    <option value="nature">Nature & Environment</option>
                    <option value="technology">Technology & Modern Life</option>
                    <option value="education">Education & Learning</option>
                    <option value="custom">Custom Theme</option>
                </select>
                <div id="custom-theme-container" style="display: none;">
                    <input 
                        type="text" 
                        id="custom-theme-input" 
                        placeholder="Describe your custom story theme..."
                    >
                </div>
            </div>

            <!-- Story Generation -->
            <div id="story-section">
                <button id="generate-story-btn" onclick="app.generateStory()">
                    ✨ Generate New Story
                </button>
                <div id="story-output"></div>
            </div>

            <!-- Translation Section -->
            <div id="translation-section" style="display: none;">
                <h3>🔤 Translate Each Sentence</h3>
                <div id="sentence-translation-container">
                    <!-- Sentence-by-sentence translation boxes will be generated here -->
                </div>
                <div id="translation-controls">
                    <button id="submit-translation-btn" onclick="app.submitSentenceTranslations()">
                        🎯 Get Feedback
                    </button>
                    <button id="mini-lesson-btn" onclick="app.generateMiniLesson()" style="display: none;">
                        📚 Generate Mini Lesson
                    </button>
                </div>
                
                <!-- Results Tabs -->
                <div id="results-tabs" style="display: none;">
                    <div id="tab-buttons">
                        <button id="feedback-tab" class="tab-button active" onclick="app.switchTab('feedback')">
                            🎯 Feedback
                        </button>
                        <button id="lesson-tab" class="tab-button" onclick="app.switchTab('lesson')">
                            📚 Mini Lesson
                        </button>
                    </div>
                    <div id="tab-content">
                        <div id="feedback-tab-content" class="tab-panel active">
                            <div id="feedback-output"></div>
                        </div>
                        <div id="lesson-tab-content" class="tab-panel">
                            <div id="lesson-output"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Chat Widget -->
        <div id="chat-widget">
            <div id="chat-toggle" onclick="app.toggleChat()">💬</div>
            <div id="chat-container" style="display: none;">
                <div id="chat-header">
                    <div id="chat-header-content">
                        <h4>🤖 AI Assistant</h4>
                        <div id="chat-controls">
                            <button id="chat-clear" onclick="app.clearChat()" title="Clear chat">🗑️</button>
                            <button id="chat-minimize" onclick="app.minimizeChat()" title="Minimize">−</button>
                            <button id="chat-close" onclick="app.toggleChat()" title="Close">×</button>
                        </div>
                    </div>
                    <div id="chat-resize-handle"></div>
                </div>
                <div id="chat-body">
                    <div id="chat-messages"></div>
                    <div id="chat-input-container">
                        <textarea 
                            id="chat-input" 
                            placeholder="Ask about grammar, vocabulary, or translations..."
                            rows="1"
                            onkeydown="app.handleChatKeyPress(event)"
                        ></textarea>
                        <button id="chat-send-btn" onclick="app.sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Help Modal -->
    <div id="help-modal" style="display: none;">
        <div id="help-content">
            <div id="help-header">
                <h2>🔑 Get Your Free Google Gemini API Key</h2>
                <button id="close-help" onclick="app.closeApiHelp()">×</button>
            </div>
            <div id="help-steps">
                <div class="help-step">
                    <h3>Step 1: Visit Google AI Studio</h3>
                    <p>Go to <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank">ai.google.dev/gemini-api/docs/api-key</a></p>
                </div>
                <div class="help-step">
                    <h3>Step 2: Sign in</h3>
                    <p>Sign in with your Google account (it's free!)</p>
                </div>
                <div class="help-step">
                    <h3>Step 3: Create API Key</h3>
                    <p>Click "Get API key" → "Create API key in new project"</p>
                </div>
                <div class="help-step">
                    <h3>Step 4: Copy & Paste</h3>
                    <p>Copy the API key and paste it into the input field above</p>
                </div>
                <div class="help-note">
                    <p><strong>✅ Free tier includes:</strong> 15 requests per minute, 1 million tokens per day</p>
                    <p><strong>🔒 Privacy:</strong> Your API key is stored locally in your browser only</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
</body>
</html>